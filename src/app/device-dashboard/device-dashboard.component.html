<div class="page-container">
  <div class="page-content">
    <div
      class="widget-section"
      *ngIf="isLoading && widgetData.length === 0; else widgetsLoaded"
    >
      <div class="widget-grid">
        <div class="widget-skeleton" *ngFor="let i of [1, 2, 3, 4, 5, 6]"></div>
      </div>
    </div>
    <ng-template #widgetsLoaded>
      <div class="widget-section">
        <div class="widget-grid">
          <app-widget-card
            *ngFor="let widget of widgetData; trackBy: trackByWidgetId"
            [icon]="widget.icon"
            [title]="widget.title"
            [value]="widget.value"
            [caption]="widget.caption"
            [accentColor]="widget.accentColor"
          >
          </app-widget-card>
        </div>
      </div>
    </ng-template>

    <div
      *ngIf="isLoading && widgetData.length === 0"
      class="chart-loading-spinner"
    >
      <div class="spinner"></div>
      <p>Đang tải dữ liệu thống kê...</p>
    </div>

    <div class="dashboard-main-content" *ngIf="!isLoading || widgetData.length > 0">
      <div
        class="filter-bar-container"
        [class.filter-bar-container--active]="currentFilter"
      >
        <div class="filter-bar">
          <ng-container *ngIf="visibleFilter">
            <span>
              Đang lọc theo:
              <strong>{{ visibleFilter.name }}</strong>
            </span>
            <button class="clear-filter-btn" (click)="clearFilter()">
              <i class="fas fa-times"></i> Xóa bộ lọc
            </button>
          </ng-container>
        </div>
      </div>

      <div class="dashboard-main-grid">
        
        <app-chart-card class="span-2"
          title="Thống Kê Trạng Thái"
          [subtitle]="statusChartSubtext"
          icon="fas fa-pie-chart"
          iconClass="icon-info"
          [isLoading]="isLoading"
          [chartOptions]="statusChartOptions"
          (chartClick)="onChartClick('status', $event)">
        </app-chart-card>

        <app-chart-card class="span-1"
          title="Số lượng theo Loại Thiết bị (Top 10)"
          icon="fas fa-tags"
          iconClass="icon-info"
          [isLoading]="isLoading"
          [chartOptions]="categoryChartOptions"
          (chartClick)="onChartClick('category', $event)">
        </app-chart-card>

        <app-chart-card class="span-1"
          [title]="locationChartTitle"
          icon="fas fa-map-marker-alt"
          iconClass="icon-info"
          [isLoading]="isLoading"
          [chartOptions]="locationChartOptions"
          (chartClick)="onChartClick('location', $event)">
        </app-chart-card>

        <div class="action-list-card span-2">
          <h3 class="card-title">
            <span>
              <i class="fas fa-tools icon-warning"></i>
              Thiết bị cần Chú ý
            </span>
          </h3>
          <div class="action-list-body">
            <ng-container *ngIf="attentionDevices.length > 0; else noAttention">
              <app-reusable-table
                [data]="attentionDevices"
                [columns]="attentionTableColumns"
                [showPaginator]="false"
                [clientSideSort]="true"
                (rowClick)="navigateToDetail($event)"
                emptyStateText="Không có thiết bị nào cần bảo trì."
              >
              </app-reusable-table>
            </ng-container>
            <ng-template #noAttention>
              <div class="list-empty-state">
                <i class="fas fa-check-circle icon-success"></i>
                <span>Không có thiết bị nào cần bảo trì.</span>
              </div>
            </ng-template>
          </div>
        </div>

        <app-chart-card class="span-3"
          title="Thiết bị mới theo Tháng"
          icon="fas fa-chart-line"
          iconClass="icon-info"
          [isLoading]="isLoading"
          [chartOptions]="trendChartOptions">
        </app-chart-card>

        <div class="action-list-card span-3">
          <h3 class="card-title">
            <span>
              <i class="fas fa-calendar-times icon-danger"></i>
              Sắp hết hạn Bảo hành (30 ngày tới)
            </span>
          </h3>
          <div class="action-list-body">
            <ng-container *ngIf="expiringDevices.length > 0; else noExpiring">
              <app-reusable-table
                [data]="expiringDevices"
                [columns]="expiringTableColumns"
                [showPaginator]="false"
                [clientSideSort]="true"
                (rowClick)="navigateToDetail($event)"
                emptyStateText="Không có thiết bị nào sắp hết hạn."
              >
              </app-reusable-table>
            </ng-container>
            <ng-template #noExpiring>
              <div class="list-empty-state">
                <i class="fas fa-check-circle icon-success"></i>
                <span>Không có thiết bị nào sắp hết hạn.</span>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>