<div class="reusable-table-wrapper">
  
  <div class="loading-shade" *ngIf="isLoadingWithDelay">
    <div class="loading-content">
      <mat-spinner diameter="32"></mat-spinner>
      <div *ngIf="showLoadingText" class="loading-text">Đang tải dữ liệu...</div>
    </div>
  </div>

  <div class="table-container" #tableContainer>
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      (matSortChange)="onMatSortChange($event)"
      class="compact-table"
      [trackBy]="trackByFn" 
    >
      <ng-container *ngFor="let col of columns" [matColumnDef]="col.key">
        
        <th
          mat-header-cell
          *matHeaderCellDef
          [mat-sort-header]="col.key"
          [disabled]="!col.sortable"
          class="compact-header"
        >
          <div class="header-content" [appTooltip]="col.label">
            {{ col.label }}
          </div>
        </th>
        
        <td mat-cell *matCellDef="let element" class="compact-cell">
          <div class="cell-content" [appTooltip]="element[col.key]" [ngSwitch]="col.key">

            <ng-container *ngSwitchCase="'actions'">
              <button class="action-menu-btn" [matMenuTriggerFor]="rowMenu" (click)="$event.stopPropagation()">
                <mat-icon>more_horiz</mat-icon>
              </button>
              <mat-menu #rowMenu="matMenu">
                <button mat-menu-item (click)="onRowAction('edit', element, $event)">
                  <mat-icon>edit</mat-icon>
                  <span>Sửa</span>
                </button>
                <button mat-menu-item (click)="onRowAction('delete', element, $event)" color="warn">
                  <mat-icon>delete</mat-icon>
                  <span>Xóa</span>
                </button>
              </mat-menu>
            </ng-container>

            <ng-container *ngSwitchCase="'TrangThai_Ten'">
              <span class="status-chip" [ngClass]="getStatusClass(element.TrangThai_Ten)">
                {{ element.TrangThai_Ten || 'N/A' }}
              </span>
            </ng-container>

            <ng-container *ngSwitchCase="'GiaMua'">
              {{ element[col.key] | currency:'VND':'symbol':'1.0-0':'vi' }}
            </ng-container>

            <ng-container *ngSwitchDefault>
              {{ element[col.key] }}
            </ng-container>
            
          </div>
        </td>
        </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" class="compact-header-row"></tr>
      
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        (click)="onRowClick(row)"
        class="clickable-row"
        [ngClass]="{ 'selected': row === selectedRow }"
      ></tr>

      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
          <div class="no-data-container">
            <div class="no-data-icon-container">
              <mat-icon class="no-data-icon">inbox</mat-icon>
            </div>
            <p class="no-data-text">{{ getEmptyStateMessage() }}</p>
            <button *ngIf="searchTerm" class="reset-btn" (click)="clearSearch()">
              <mat-icon>refresh</mat-icon>
              Đặt lại tìm kiếm
            </button>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <mat-paginator
    [pageSize]="pageSize"
    [pageSizeOptions]="pageSizeOptions"
    [length]="dataSource.data.length"
    (page)="onPageChange($event)"
    showFirstLastButtons
    aria-label="Select page of results"
    class="compact-paginator"
  >
  </mat-paginator>
</div>