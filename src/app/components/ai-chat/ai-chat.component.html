<div class="ai-window" [class.open]="llmService.isOpen()" [class.navigating-mode]="llmService.isNavigating()">
  
  <div class="ai-header">
    <div class="header-left">
      <div class="ai-avatar-wrapper">
        <div class="avatar-ring">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="pulse-dot" [class.online]="llmService.modelLoaded()"></div>
      </div>
      <div class="header-info">
        <h3 class="title">Trợ lý IT Assistant</h3>
        <span class="status">
          {{ llmService.modelLoaded() ? 'Sẵn sàng hỗ trợ' : (llmService.isModelLoading() ? 'Đang kết nối...' : 'Ngoại tuyến') }}
        </span>
      </div>
    </div>

    <div class="header-right">
      @if (llmService.modelLoaded() && llmService.contextUsage() > 50) {
        <div 
          class="context-indicator" 
          [class.medium]="getContextLevel() === 'medium'"
          [class.high]="getContextLevel() === 'high'"
          [title]="'Bộ nhớ hội thoại: ' + llmService.contextUsage() + '%'">
          <i class="fas fa-brain"></i>
          <span class="context-value">{{ llmService.contextUsage() }}%</span>
        </div>
      }

      <button class="close-btn" (click)="closeChat()" title="Đóng">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div class="ai-body loading-view" *ngIf="llmService.isModelLoading() && !llmService.modelLoaded()">
    <div class="scan-container">
      <div class="scan-grid"></div>
      <div class="scan-radar"></div>
      <div class="scan-icon">
        <i class="fas fa-server"></i>
      </div>
    </div>
    <p class="loading-text">
      {{ llmService.loadProgress() }}
      <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
    </p>
  </div>

  <div class="ai-body chat-view" *ngIf="llmService.modelLoaded()" #scrollContainer>
    
    @for (msg of llmService.messages(); track trackByMessage($index, msg)) {
      @if (msg.role !== 'system' && msg.role !== 'tool' && (msg.role !== 'assistant' || msg.content)) {
        <div class="message-row" [ngClass]="msg.role">
          
          @if (msg.role === 'assistant') {
            <div class="msg-avatar">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/>
              </svg>
            </div>
          }

          <div class="bubble" [innerHTML]="processContent(msg.content) | markdown"></div>
        </div>
      }
    }

    @if (shouldShowLoadingIndicator()) {
      <div class="message-row assistant">
        <div class="msg-avatar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/>
          </svg>
        </div>
        <div class="bubble thinking-bubble">
          <span class="gradient-text">Đang suy nghĩ</span>
          <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
      </div>
    }
  </div>
  
  @if (llmService.isNavigating()) {
    <div class="nav-overlay">
      <div class="warp-tunnel"></div>
      <div class="nav-content">
        <div class="nav-icon-wrapper">
          <i class="fas fa-rocket nav-icon"></i>
        </div>
        <p>Đang chuyển hướng...</p>
      </div>
    </div>
  }

  <div class="ai-footer" *ngIf="llmService.modelLoaded()">
    <div class="toolbar">
      @if (llmService.contextUsage() >= 80) {
        <span class="context-warning">
          <i class="fas fa-exclamation-triangle"></i>
          Bộ nhớ gần đầy
        </span>
      }
      
      @if (hasUserMessages()) {
        <button 
          class="clear-chat-btn" 
          (click)="llmService.resetChat()" 
          title="Xóa lịch sử chat" 
          [disabled]="llmService.isGenerating()">
          <i class="fas fa-trash-alt"></i> Xóa lịch sử
        </button>
      }
    </div>

    <div class="input-container">
      <input 
        type="text" 
        [(ngModel)]="userInput" 
        (keyup.enter)="handleMainButton()"
        [disabled]="llmService.isGenerating()"
        placeholder="Hỏi về cách sử dụng..." 
        class="chat-input"
        autocomplete="off"
      >
      
      <button 
        class="send-btn" 
        (click)="handleMainButton()" 
        [disabled]="!llmService.isGenerating() && !userInput.trim()"
        [class.generating]="llmService.isGenerating()"
        [title]="llmService.isGenerating() ? 'Dừng lại' : 'Gửi'">
        
        @if (llmService.isGenerating()) {
          <div class="stop-icon"></div>
        } @else {
          <i class="fas fa-arrow-up"></i>
        }
      </button>
    </div>
  </div>
</div>