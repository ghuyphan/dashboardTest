<div class="ai-window" [class.open]="llmService.isOpen()" [class.navigating-mode]="llmService.isNavigating()">
  
  <!-- HEADER -->
  <div class="ai-header">
    <div class="header-left">
      <div class="ai-avatar-wrapper">
        <div class="avatar-ring">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" fill="currentColor"/>
          </svg>
        </div>
        <!-- Status is always online now because the Proxy handles connection -->
        <div class="pulse-dot online"></div>
      </div>
      <div class="header-info">
        <h3 class="title">Trợ lý IT Assistant</h3>
        <span class="status">Sẵn sàng hỗ trợ</span>
      </div>
    </div>

    <div class="header-right">
      <!-- Context Usage removed as it's handled server-side now -->
      
      <button class="close-btn" (click)="closeChat()" title="Đóng">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <!-- CHAT BODY -->
  <!-- Removed loading-view and @else wrapper since chat is always ready -->
  <div class="ai-body chat-view" #scrollContainer>
    
    <!-- MESSAGES LOOP -->
    @for (msg of llmService.messages(); track trackByMessage($index, msg)) {
      <!-- Hide System messages and Empty Assistant placeholders -->
      @if (msg.role !== 'system' && (msg.role !== 'assistant' || msg.content)) {
        <div class="message-row" [ngClass]="msg.role">
          
          @if (msg.role === 'assistant') {
            <div class="msg-avatar">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/>
              </svg>
            </div>
          }

          <div class="bubble">
            <!-- Render Markdown -->
            <div [innerHTML]="processContent(msg.content) | markdown"></div>
          </div>
        </div>
      }
    }

    <!-- TYPING INDICATOR -->
    @if (shouldShowLoadingIndicator()) {
      <div class="message-row assistant">
        <div class="msg-avatar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/>
          </svg>
        </div>
        <div class="bubble thinking-bubble">
          <span class="gradient-text">Đang suy nghĩ</span>
          <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
      </div>
    }
  </div>
  
  <!-- NAVIGATION OVERLAY (Warp Effect) -->
  @if (llmService.isNavigating()) {
    <div class="nav-overlay">
      <div class="warp-tunnel"></div>
      <div class="nav-content">
        <div class="nav-icon-wrapper">
          <i class="fas fa-rocket nav-icon"></i>
        </div>
        <p>Đang chuyển màn hình...</p>
      </div>
    </div>
  }

  <!-- FOOTER -->
  <!-- Removed @if (modelLoaded) wrapper -->
  <div class="ai-footer">
    <div class="toolbar">
      <!-- Only show Clear button if there is history -->
      @if (hasUserMessages()) {
        <button 
          class="clear-chat-btn" 
          (click)="llmService.resetChat()" 
          title="Xóa lịch sử chat" 
          [disabled]="llmService.isGenerating()">
          <i class="fas fa-trash-alt"></i> Xóa lịch sử
        </button>
      }
    </div>

    <div class="input-container">
      <input 
        type="text" 
        [(ngModel)]="userInput" 
        (keyup.enter)="handleMainButton()"
        [disabled]="llmService.isGenerating()"
        placeholder="Hỏi về cách sử dụng..." 
        class="chat-input"
        autocomplete="off"
      >
      
      <button 
        class="send-btn" 
        (click)="handleMainButton()" 
        [disabled]="!llmService.isGenerating() && !userInput.trim()"
        [class.generating]="llmService.isGenerating()"
        [title]="llmService.isGenerating() ? 'Dừng lại' : 'Gửi'">
        
        @if (llmService.isGenerating()) {
          <div class="stop-icon"></div>
        } @else {
          <i class="fas fa-arrow-up"></i>
        }
      </button>
    </div>
  </div>
</div>