<div class="ai-window" [class.open]="llmService.isOpen()">
  
  <div class="ai-header">
    <div class="header-left">
      <div class="ai-avatar-wrapper">
        <div class="avatar-ring">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="pulse-dot" [class.online]="llmService.modelLoaded()"></div>
      </div>
      <div class="header-info">
        <h3 class="title">Trợ lý Homi</h3>
        <span class="status">{{ llmService.modelLoaded() ? 'Sẵn sàng hỗ trợ' : 'Đang kết nối...' }}</span>
      </div>
    </div>
    
    <button class="close-btn" (click)="closeChat()" title="Đóng">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <div class="ai-body loading-view" *ngIf="!llmService.modelLoaded() && llmService.isModelLoading()">
    <div class="loader-content">
      <div class="ai-pulse-ring"><div></div><div></div><div></div><div></div></div>
      <p class="loading-text">{{ llmService.loadProgress() }}</p>
    </div>
  </div>

  <div class="ai-body chat-view" *ngIf="llmService.modelLoaded()" #scrollContainer>
    
    <div class="chat-intro">
      <span class="intro-badge">Guide Mode</span>
      <p>Xin chào! Tôi có thể giúp bạn tìm kiếm chức năng hoặc hướng dẫn sử dụng phần mềm.</p>
    </div>

    @for (msg of llmService.messages(); track $index) {
      @if (msg.role !== 'system' && (msg.role !== 'assistant' || msg.content)) {
        <div class="message-row" [ngClass]="msg.role">
          
          @if(msg.role === 'assistant') {
            <div class="msg-avatar">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/>
              </svg>
            </div>
          }

          <div class="bubble" [innerHTML]="msg.content | markdown"></div>
        </div>
      }
    }

    @if (shouldShowThinking()) {
      <div class="message-row assistant">
        <div class="msg-avatar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/>
          </svg>
        </div>
        <div class="bubble thinking-bubble">
          <span class="gradient-text">Đang suy nghĩ</span>
          <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
      </div>
    }
  </div>

  <div class="ai-footer" *ngIf="llmService.modelLoaded()">
    
    <div class="toolbar" style="justify-content: flex-end;">
      <button class="clear-chat-btn" (click)="llmService.resetChat()" title="Xóa lịch sử chat" [disabled]="llmService.isGenerating()">
        <i class="fas fa-trash-alt"></i> Xóa lịch sử
      </button>
    </div>

    <div class="input-container">
      <input 
        type="text" 
        [(ngModel)]="userInput" 
        (keyup.enter)="handleMainButton()"
        [disabled]="llmService.isGenerating()"
        placeholder="Hỏi về cách sử dụng..." 
        class="chat-input"
        autocomplete="off"
      >
      
      <button 
        class="send-btn" 
        (click)="handleMainButton()" 
        [disabled]="!llmService.isGenerating() && !userInput.trim()"
        [class.generating]="llmService.isGenerating()"
        [title]="llmService.isGenerating() ? 'Dừng lại' : 'Gửi'">
        
        @if (llmService.isGenerating()) {
          <div class="stop-icon"></div>
        } @else {
          <i class="fas fa-arrow-up"></i>
        }
      </button>
    </div>
  </div>
</div>