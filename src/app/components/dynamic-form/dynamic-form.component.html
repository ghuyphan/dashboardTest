<!-- This template is generic and renders any form config -->
<div class="dynamic-form-container">
  <form [formGroup]="dynamicForm" (ngSubmit)="onSave()" novalidate>
    <div class="form-body">
      
      <div *ngIf="formConfig" class="dynamic-form-layout">
        
        <!-- 1. OUTER LOOP: Iterate over each 'row' -->
        <div *ngFor="let row of formConfig.formRows" class="form-row">
          
          <!-- 2. INNER LOOP: Iterate over controls *within* that row -->
          <div *ngFor="let control of row.controls"
               class="form-group"
               [ngClass]="control.cssClass"
               [style.flex-grow]="control.layout_flexGrow">

            <label [for]="control.controlName">{{ control.label }}</label>

            <!-- 3. Use ngSwitch to render the correct control type -->
            <div [ngSwitch]="control.controlType">

              <!-- Case: 'text' input -->
              <input *ngSwitchCase="'text'"
                     [type]="'text'"
                     [id]="control.controlName"
                     [formControlName]="control.controlName"
                     [placeholder]="control.placeholder || ''"
                     class="form-control"
                     [class.is-invalid]="isInvalid(control.controlName)"
              />

              <!-- Case: 'dropdown' / 'select' -->
              <select *ngSwitchCase="'dropdown'"
                      [id]="control.controlName"
                      [formControlName]="control.controlName"
                      class="form-control"
                      [class.is-invalid]="isInvalid(control.controlName)">
                
                <option *ngFor="let opt of control.options" [ngValue]="opt.key">
                  {{ opt.value }}
                </option>
              </select>

              <!-- Case: 'textarea' -->
              <textarea *ngSwitchCase="'textarea'"
                        [id]="control.controlName"
                        [formControlName]="control.controlName"
                        [placeholder]="control.placeholder || ''"
                        class="form-control"
                        rows="3"
                        [class.is-invalid]="isInvalid(control.controlName)">
              </textarea>
              
              <!-- Case: 'checkbox' -->
              <div *ngSwitchCase="'checkbox'" class="checkbox-wrapper">
                 <input type="checkbox"
                        [id]="control.controlName"
                        [formControlName]="control.controlName"
                        class="form-check-input"
                  />
                  <!-- The main <label> already covers checkboxes -->
              </div>

            </div>

            <!-- 4. Dynamic Validation Messages -->
            <div *ngIf="isInvalid(control.controlName)" class="invalid-feedback">
              {{ getErrorMessage(control) }}
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- These buttons are part of the reusable component -->
    <div class="form-actions">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="onCancel()"
        [disabled]="isLoading"
      >
        Hủy bỏ
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="dynamicForm.invalid || isLoading"
      >
        <span *ngIf="!isLoading">Lưu</span>
        <span *ngIf="isLoading">Đang lưu...</span>
      </button>
    </div>
  </form>
</div>