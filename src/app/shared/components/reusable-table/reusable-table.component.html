<div class="reusable-table-wrapper">

  <div class="loading-shade" [class.hidden]="!isLoading()" aria-hidden="true">
    <div class="app-loading-container">
      <div class="app-loading-spinner"></div>
      @if (showLoadingText()) {
      <p>Đang tải dữ liệu...</p>
      }
    </div>
  </div>

  <div class="table-container" #tableContainer>
    <table mat-table [dataSource]="dataSource" matSort (matSortChange)="onMatSortChange($event)" class="compact-table"
      [trackBy]="trackByFn">
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="compact-header mat-column-select">
          <mat-checkbox (change)="$event ? masterToggle() : null" [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="checkboxLabel()"
            (click)="onCheckboxClick($event)">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row" class="compact-cell mat-column-select">
          <mat-checkbox (click)="toggleRowSelection(row, $event)" [checked]="selection.isSelected(row)"
            [aria-label]="checkboxLabel(row)">
          </mat-checkbox>
        </td>
      </ng-container>

      @for (col of columns(); track col.key) {
      <ng-container [matColumnDef]="col.key" [sticky]="col.sticky === 'start'" [stickyEnd]="col.sticky === 'end'">

        <th mat-header-cell *matHeaderCellDef [mat-sort-header]="col.key" [disabled]="!col.sortable"
          class="compact-header" [style.width]="col.width" [style.min-width]="col.width" [style.max-width]="col.width">
          <div class="header-content" [appTooltip]="col.label">
            {{ col.label }}
          </div>
        </th>

        <td mat-cell *matCellDef="let element" class="compact-cell" [style.width]="col.width"
          [style.min-width]="col.width" [style.max-width]="col.width">
          <div class="cell-content" [appTooltip]="element[col.key]">
            @switch (col.type) {

            @case ('actions') {
            <button class="action-menu-btn" [matMenuTriggerFor]="rowMenu" (click)="$event.stopPropagation()">
              <mat-icon>more_horiz</mat-icon>
            </button>
            <mat-menu #rowMenu="matMenu">
              @for (action of rowActions(); track action.action) {
              @if (!action.visibleFn || action.visibleFn(element)) {
              <button mat-menu-item (click)="onActionClick(action.action, element, $event)">
                <mat-icon [color]="action.color">{{ action.icon }}</mat-icon>
                <span [ngClass]="action.color ? 'mat-' + action.color : ''">{{ action.label }}</span>
              </button>
              }
              }
            </mat-menu>
            }

            @case ('status') {
            <span class="status-chip"
              [ngClass]="col.statusClassFn ? col.statusClassFn(element[col.key]) : 'status-default'"
              [innerHTML]="element[col.key] | highlightSearch: searchTerm()">
            </span>
            }

            @case ('currency') {
            {{ element[col.key] | currency:'VND':'symbol':'1.0-0':'vi' }}
            }

            @case ('date') {
            @if (isDateValue(element[col.key])) {
            {{ element[col.key] | date:'dd/MM/yyyy' }}
            } @else {
            {{ element[col.key] }}
            }
            }

            @default {
            <span [innerHTML]="element[col.key] | highlightSearch: searchTerm()"></span>
            }
            }
          </div>
        </td>
      </ng-container>
      }

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" class="compact-header-row"></tr>

      <tr mat-row *matRowDef="let row; columns: displayedColumns" (click)="onRowClick(row)" class="clickable-row"
        [ngClass]="{ 
          'selected': row === selectedRow && !enableMultiSelect(),
          'multi-selected': selection.isSelected(row)
        }"></tr>

      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">

          <div class="no-data-container">
            <div class="no-data-icon-container">
              <mat-icon class="no-data-icon">inbox</mat-icon>
            </div>
            <p class="no-data-text">{{ getEmptyStateMessage() }}</p>
            @if (searchTerm()) {
            <button class="reset-btn" (click)="clearSearch()">
              <mat-icon>refresh</mat-icon>
              Đặt lại tìm kiếm
            </button>
            }
          </div>
        </td>
      </tr>
    </table>
  </div>

  @if (showPaginator()) {
  <mat-paginator [pageSize]="pageSize()" [pageSizeOptions]="pageSizeOptions()" [length]="totalDataLength()"
    (page)="onPageChange($event)" showFirstLastButtons aria-label="Select page of results" class="compact-paginator">
  </mat-paginator>
  }
</div>